<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cskaoyan.hackernews.mapper.MessageMapper">
    <resultMap id="BaseResultMap" type="com.cskaoyan.hackernews.bean.Message">
    <result column="id" property="id"/>
    <result column="content" property="content"/>
    <result column="from_id" property="fromId" />
    <result column="to_id" property="toId" />
    <result column="has_read" property="hasRead" />
    <result column="conversation_id" property="conversationId" />
    <result column="created_date" property="createdDate"/>
  </resultMap>
  <sql id="Base_Column_List">
    id, from_id, to_id, content,created_date,has_read,conversation_id
</sql>

  <select id="selectByConversationId" resultMap="BaseResultMap">
      select <include refid="Base_Column_List"/>
      from message
      where conversation_id = #{conversationId}
  </select>

  <select id="selectByUserId" resultMap="BaseResultMap">
      select <include refid="Base_Column_List"/>
      from message
      where from_id = #{userId} or to_id = #{userId}
  </select>

  <select id="selectConversationIdByUserId" resultType="string">
      select conversation_id
      from message
      where from_id = #{userId} or to_id = #{userId}
      group by conversation_id
  </select>
    <select id="selectCountGroupByConversationId" resultType="int">
      select count(*)
      from message
      where conversation_id = #{conversationId}
      group by conversation_id
  </select>

  <update id="updateMessageReadByConversationId">
      update message
      set has_read = 1
      where conversation_id = #{conversationId}
  </update>

  <insert id="insert">
      <selectKey resultType="java.lang.Integer" order="AFTER" keyProperty="id">
          select last_insert_id()
      </selectKey>
      insert into message (from_id, to_id, content,created_date,has_read,conversation_id)
      value (#{fromId}, #{toId}, #{content},#{createdDate},0,#{conversationId})
  </insert>
</mapper>